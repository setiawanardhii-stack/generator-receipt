<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generator Receipt</title>

<!-- LIBRARY -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
body{font-family:Arial;background:#f2f4ff;padding:20px}
.container{max-width:1000px;margin:auto;background:#fff;padding:20px;border-radius:12px}
input,button{padding:10px;border-radius:6px}
button{cursor:pointer}
#resultList div{margin:10px 0;padding:10px;border:1px solid #ddd;border-radius:8px}
.progress{height:25px;background:#eee;border-radius:20px;overflow:hidden}
.progress span{display:block;height:100%;background:#1a237e;color:#fff;text-align:center}
</style>
</head>

<body>
<div class="container">
<h2>üßæ Generator Receipt (Google Sheet FIX)</h2>

<hr>

<h3>üìÅ Upload Excel</h3>
<input type="file" id="fileInput" accept=".xls,.xlsx">

<hr>

<h3>üìä Import Google Sheet</h3>
<input type="text" id="sheetUrl" placeholder="Paste URL / ID Google Sheet" style="width:60%">
<button onclick="processSheetUrl()">Proses</button>

<hr>

<div id="sheetSelector" style="display:none">
<select id="sheetSelect" onchange="onSheetSelected()"></select>
</div>

<hr>

<div class="progress" style="display:none" id="progressBox">
<span id="progressFill">0%</span>
</div>

<div id="resultList"></div>
</div>

<script>
const { jsPDF } = window.jspdf;

/* ==============================
   GOOGLE CONFIG
================================ */
const GOOGLE_CLIENT_ID = "ISI_CLIENT_ID_ANDA";
const SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";

let gToken = null;
let generatedPDFs = [];
let currentWorkbook = null;
let gSheetId = null;
let gSheetNames = [];

/* ==============================
   GOOGLE AUTH
================================ */
function authGoogle(){
    const client = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SCOPES,
        callback:(res)=>{
            gToken = res.access_token;
            alert("Login Google berhasil");
        }
    });
    client.requestAccessToken();
}

window.onload = authGoogle;

/* ==============================
   UTIL
================================ */
function extractSpreadsheetId(url){
    const m = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
    return m ? m[1] : url;
}

function formatRupiah(v){
    return "Rp " + Number(v).toLocaleString("id-ID");
}

function formatExcelDate(v){
    if(typeof v==="number"){
        const d=new Date((v-25569)*86400*1000);
        return d.toLocaleDateString("id-ID");
    }
    return v;
}

/* ==============================
   GOOGLE SHEET PROCESS
================================ */
async function processSheetUrl(){
    if(!gToken){ alert("Login Google dulu"); return; }

    gSheetId = extractSpreadsheetId(sheetUrl.value);

    const meta = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${gSheetId}`,
        {headers:{Authorization:`Bearer ${gToken}`}}
    ).then(r=>r.json());

    gSheetNames = meta.sheets.map(s=>s.properties.title);

    const sel = document.getElementById("sheetSelect");
    sel.innerHTML="";
    gSheetNames.forEach((n,i)=>{
        sel.innerHTML+=`<option value="${i}">${n}</option>`;
    });
    document.getElementById("sheetSelector").style.display="block";
}

async function onSheetSelected(){
    const name = gSheetNames[sheetSelect.value];
    const res = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${gSheetId}/values/${encodeURIComponent(name)}`,
        {headers:{Authorization:`Bearer ${gToken}`}}
    ).then(r=>r.json());

    const sheet = XLSX.utils.aoa_to_sheet(res.values);
    currentWorkbook = {SheetNames:[name],Sheets:{[name]:sheet}};
    processExcel(currentWorkbook);
}

/* ==============================
   EXCEL UPLOAD
================================ */
fileInput.onchange=e=>{
    const r=new FileReader();
    r.onload=ev=>{
        const wb=XLSX.read(new Uint8Array(ev.target.result),{type:"array"});
        currentWorkbook=wb;
        processExcel(wb);
    };
    r.readAsArrayBuffer(e.target.files[0]);
};

/* ==============================
   PROCESS DATA
================================ */
function processExcel(workbook){
    generatedPDFs=[];
    resultList.innerHTML="";
    progressBox.style.display="block";

    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet,{header:1,defval:""}).slice(1);

    rows.forEach((r,i)=>{
        setTimeout(()=>{
            generatePDF({
                date:r[1],
                merchant:r[4],
                rrn:r[5],
                ref:r[6],
                amount:r[7]
            },i,rows.length);
        },i*150);
    });
}

/* ==============================
   PDF GENERATOR
================================ */
function generatePDF(d,i,total){
    const doc=new jsPDF({unit:"mm",format:[100,125]});

    doc.text("INVOICE",50,10,{align:"center"});
    doc.text("Merchant : "+d.merchant,5,25);
    doc.text("RRN      : "+d.rrn,5,32);
    doc.text("Ref      : "+d.ref,5,39);
    doc.text("Amount   : "+formatRupiah(d.amount),5,46);
    doc.text("Date     : "+formatExcelDate(d.date),5,53);

    const blob=doc.output("blob");
    const url=URL.createObjectURL(blob);
    const name=`EV_${d.rrn||i}.pdf`;

    generatedPDFs.push({name,url});

    resultList.innerHTML+=`
      <div>
        <b>${name}</b><br>
        <a href="${url}" download="${name}">Download</a>
      </div>
    `;

    const p=Math.round(((i+1)/total)*100);
    progressFill.style.width=p+"%";
    progressFill.textContent=p+"%";
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generator Receipt</title>

<!-- LIB -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<style>
body{font-family:Segoe UI;background:#f2f4ff;padding:20px}
.container{max-width:1100px;margin:auto;background:#fff;padding:25px;border-radius:14px}
h2,h3{color:#1a237e}
input,button,select{padding:10px;border-radius:6px}
button{cursor:pointer;background:#1a237e;color:#fff;border:none}
button:disabled{background:#aaa}
.section{margin:20px 0}
.result-item{border:1px solid #ddd;padding:10px;margin:10px 0;border-radius:8px}
.progress{height:26px;background:#eee;border-radius:20px;overflow:hidden;display:none}
.progress span{display:block;height:100%;background:#1a237e;color:#fff;text-align:center}
</style>
</head>

<body>
<div class="container">

<h2>üßæ Generator Receipt</h2>

<div class="section">
<h3>üìÅ Upload Excel</h3>
<input type="file" id="fileInput" accept=".xls,.xlsx">
</div>

<div class="section">
<h3>üìä Import Google Sheet</h3>
<input type="text" id="sheetUrl" placeholder="Paste URL / ID Google Sheet" style="width:60%">
<button onclick="processSheetUrl()">Proses</button>
</div>

<div class="section" id="sheetSelector" style="display:none">
<h3>üìÑ Pilih Sheet</h3>
<select id="sheetSelect" onchange="onSheetSelected()"></select>
</div>

<div class="section">
<h3>üîë Google Drive</h3>
<button onclick="loginGoogle()">Login Google</button>
<button onclick="openFolderPicker()" id="pickFolderBtn" disabled>Pilih Folder</button>
<p id="folderInfo"></p>
</div>

<div class="progress" id="progressBox">
<span id="progressFill">0%</span>
</div>

<div id="resultList"></div>

<button onclick="uploadAllToGoogleDrive()" id="uploadBtn" disabled>
‚òÅÔ∏è Upload ke Google Drive
</button>

</div>

<script>
const { jsPDF } = window.jspdf;

/* =========================
   CONFIG
========================= */
const GOOGLE_CLIENT_ID = "328487655564-bcmmhhn8dou3dtj1jf8d63fffq8kc5lb.apps.googleusercontent.com";
const GOOGLE_API_KEY   = "AIzaSyCmQZeqq_QMdlShrJoCuWXp9RVh9aVXEJ8";
const SCOPES = "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets.readonly";

/* =========================
   STATE
========================= */
let gToken = null;
let pickedFolderId = null;
let pickedFolderName = '';
let generatedPDFs = [];
let currentWorkbook = null;
let gSheetId = null;
let gSheetNames = [];

/* =========================
   AUTH
========================= */
function loginGoogle(){
    const client = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SCOPES,
        callback: res => {
            gToken = res.access_token;
            document.getElementById('pickFolderBtn').disabled = false;
            alert("Login Google berhasil");
        }
    });
    client.requestAccessToken();
}

/* =========================
   DRIVE PICKER
========================= */
function openFolderPicker(){
    if(!gToken) return alert("Login Google dulu");

    gapi.load('picker', ()=>{
        const view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
            .setIncludeFolders(true)
            .setSelectFolderEnabled(true);

        const picker = new google.picker.PickerBuilder()
            .addView(view)
            .setOAuthToken(gToken)
            .setDeveloperKey(GOOGLE_API_KEY)
            .setCallback(pickerCallback)
            .build();

        picker.setVisible(true);
    });
}

function pickerCallback(data){
    if(data.action === google.picker.Action.PICKED){
        const f = data.docs[0];
        pickedFolderId = f.id;
        pickedFolderName = f.name;
        document.getElementById('folderInfo').innerHTML =
            `üìÅ Folder terpilih: <b>${pickedFolderName}</b>`;
        document.getElementById('uploadBtn').disabled = false;
    }
}

/* =========================
   GOOGLE SHEET
========================= */
function extractSpreadsheetId(v){
    const m = v.match(/\/d\/([a-zA-Z0-9-_]+)/);
    return m ? m[1] : v;
}

async function processSheetUrl(){
    if(!gToken) return alert("Login Google dulu");

    gSheetId = extractSpreadsheetId(sheetUrl.value);

    const meta = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${gSheetId}`,
        {headers:{Authorization:`Bearer ${gToken}`}}
    ).then(r=>r.json());

    gSheetNames = meta.sheets.map(s=>s.properties.title);

    const sel = document.getElementById('sheetSelect');
    sel.innerHTML = '';
    gSheetNames.forEach((n,i)=>{
        sel.innerHTML += `<option value="${i}">${n}</option>`;
    });
    document.getElementById('sheetSelector').style.display = 'block';
}

async function onSheetSelected(){
    const name = gSheetNames[sheetSelect.value];

    const res = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${gSheetId}/values/${encodeURIComponent(name)}`,
        {headers:{Authorization:`Bearer ${gToken}`}}
    ).then(r=>r.json());

    const sheet = XLSX.utils.aoa_to_sheet(res.values);
    currentWorkbook = {SheetNames:[name],Sheets:{[name]:sheet}};
    processExcel(currentWorkbook);
}

/* =========================
   EXCEL UPLOAD
========================= */
fileInput.onchange = e=>{
    const r = new FileReader();
    r.onload = ev=>{
        currentWorkbook = XLSX.read(new Uint8Array(ev.target.result),{type:"array"});
        processExcel(currentWorkbook);
    };
    r.readAsArrayBuffer(e.target.files[0]);
};

/* =========================
   PROCESS DATA
========================= */
function processExcel(workbook){
    generatedPDFs = [];
    resultList.innerHTML = '';
    progressBox.style.display = 'block';

    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet,{header:1,defval:""}).slice(1);

    rows.forEach((r,i)=>{
        setTimeout(()=>{
            generatePDF({
                date:r[1],
                merchant:r[4],
                rrn:r[5],
                ref:r[6],
                amount:r[7]
            },i,rows.length);
        }, i*200);
    });
}

/* =========================
   PDF
========================= */
function formatRupiah(v){
    return "Rp " + Number(v).toLocaleString("id-ID");
}
function formatExcelDate(v){
    if(typeof v==="number"){
        return new Date((v-25569)*86400*1000).toLocaleDateString("id-ID");
    }
    return v;
}

function generatePDF(d,i,total){
    const doc = new jsPDF({unit:"mm",format:[100,125]});

    doc.text("INVOICE PAYMENT",50,10,{align:"center"});
    doc.text("Merchant : "+d.merchant,5,25);
    doc.text("RRN      : "+d.rrn,5,32);
    doc.text("Ref      : "+d.ref,5,39);
    doc.text("Amount   : "+formatRupiah(d.amount),5,46);
    doc.text("Date     : "+formatExcelDate(d.date),5,53);

    const blob = doc.output("blob");
    const url  = URL.createObjectURL(blob);
    const name = `EV_${d.rrn || i}.pdf`;

    generatedPDFs.push({name,blob});

    resultList.innerHTML += `
      <div class="result-item">
        <b>${name}</b><br>
        <a href="${url}" download="${name}">Download</a>
      </div>
    `;

    const p = Math.round(((i+1)/total)*100);
    progressFill.style.width = p+"%";
    progressFill.textContent = p+"%";
}

/* =========================
   UPLOAD DRIVE
========================= */
async function uploadAllToGoogleDrive(){
    if(!pickedFolderId) return alert("Pilih folder dulu");

    for(const pdf of generatedPDFs){
        const meta = {
            name: pdf.name,
            parents: [pickedFolderId]
        };

        const fd = new FormData();
        fd.append('metadata', new Blob([JSON.stringify(meta)],{type:'application/json'}));
        fd.append('file', pdf.blob);

        await fetch(
            'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
            {
                method:'POST',
                headers:{Authorization:`Bearer ${gToken}`},
                body:fd
            }
        );
    }
    alert(`Upload selesai ke folder "${pickedFolderName}"`);
}
</script>
</body>
</html>